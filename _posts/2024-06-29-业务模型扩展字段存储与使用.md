---
title: 业务模型扩展字段存储与使用
categories: [编程, 设计模式]
tags: [design pattern]
---


构建业务模型时，通常模型会保留扩展信息，在存储上一般使用`JSON`格式存储到db中，`JSON`虽然有较好的扩展性，但面对不同类型的扩展是没有强约束的，只能依赖代码中写入读取时进行序列化/反序列化操作，
简单结构且不做查询条件时`JSON`可以满足需求， 但有些场景要求根据扩展字段进行查询，虽然有`SQL`有类似`JSON_CONTAINS`关键字搜索JSON内部字段，但不是所有db及其版本都支持`JSON`加内部索引的，且SQL语句复杂，难以维护。


本文介绍了一种业务模型扩展字段的存储方式以及使用方法。

设想一个物流发货场景，物流系统接收公司内部不同业务线的发货请求生成发货单，同时不同业务线的发货单数据有不同的扩展字段，
比如用户商城下单产生一个发货单，发货单需要关联订单号、支付金额等扩展数据；用户有赠品需要发货，发货单需要关联赠品订单号、赠品类型、赠品编号等扩展数据；
运营手动给某个用户发货，发货单需要关联发货审批编号，发货申请人等扩展数据；用户之前发的物流有问题，提起申诉，需要重新发货，问题件类型的发货单需要关联申诉编号、原发货单号、原发货类型。

直接在发货单主表使用非结构化的JSON字段存储以上数据，不优雅，作为物流域主表其实不关系上游扩展字段，且扩展字段后期会导致该表膨胀，查询和插入性能都会有影响。

因此，我们只在发货单主表`logistcs_delivery_invoice`存储物流域数据，扩展数据根据`发货单类型`路由到不同的扩展表，在根据`发货单编号`关联其中的数据，在扩展表中，可以直接使用结构化的存储，方便后续查询。
其实体关系图如下：

![](/assets/2024/06/29/ext.png)
